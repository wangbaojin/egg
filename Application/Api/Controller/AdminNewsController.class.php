<?php
/**
 * Created by PhpStorm.
 * User: lkk
 * Date: 17/11/13
 * Time: ä¸‹åˆ5:19
 */

namespace Api\Controller;

use Think\Controller;

class AdminNewsController extends AdminPublicController
{
    private $_not_null = array(
        'title'       => 'æ–‡å­—æ ‡é¢˜éƒ½ä¸å¡«,ä½ æ˜¯ä¸æ˜¯é£˜äº†',
        'come_from'   => 'é¥®æ°´æ€æº,æ¥ä¸ªæ–‡ç« æ¥æºå‘—',
        'article_url' => 'æ–‡ç« é“¾æ¥éƒ½æ²¡æœ‰,ä½ è®©æˆ‘è·³ä¸€è·³?',
        'newstime'    => 'é€‰ä¸ªå‘å¸ƒæ—¶é—´å§,æ“ç¢äº†å¿ƒ',
        'abstract'    => 'æ–‡ç« æ‘˜è¦å¡«ä¸‹,ä¸è¦çš®',
    );

    private $_pic_path = './Public/images/uploads/news';

    public function _initialize()
    {
        parent::_initialize(); // TODO: Change the autogenerated stub
        // å®ä¾‹hua
        $this->_m = M($this->_table_name);
    }

    public function index()
    {
        // åˆ†é¡µ
        $map = array();
        if(I('get.title')) $map['title'] = array('like',"%".I('get.title')."%");
        $page = (int)I('page');
        $data['page_limit']  = 20;
        $data['total_count'] = $this->_m->where($map)->count();
        $data['total_page']  = ceil($data['total_count']/$data['page_limit']);
        $data['now_page']    = ($page > 0 and $page <= $data['total_page']) ? $page : 1;
        $list = $this->_m->where($map)->page($page,$data['page_limit'])->order('(top_num=1) desc,id desc')->select();

        // å¤„ç†æ•°æ®
        foreach ($list as $k=>$v)
        {
            $list[$k] = $this->disposeData($v);
        }

        $Page = new \Think\Page($data['total_count'],$data['page_limit']);
        $show = $Page->show();// åˆ†é¡µæ˜¾ç¤ºè¾“å‡º
        $this->assign('page',$show);// èµ‹å€¼åˆ†é¡µè¾“å‡º
        $this->assign('list',$list);
        $this->assign('count',$data['total_count']);
        $this->display();
    }

    public function del()
    {
        $id  = I('get.id');
        $del = $this->_m->where('id='.$id)->delete();
        $msg = $del ? 'success' : 'åˆ é™¤å¤±è´¥';
        die($msg);
    }

    public function add()
    {
        $data = I('post.');

        if($data) {

            foreach ($this->_not_null as $k=>$v)
            {
                if(!$data[$k]) die($v);
            }

            if($data['top_num'])
            {
                $this->_m->where('top_num=1')->setField('top_num',0);
                $data['top_num'] = 1;
            }
            $data['create_time'] = time();
            $data['newstime'] = strtotime($data['newstime']);
            $data['newstime_date'] = date('Y-m-d',$data['newstime']);
            $res = $this->_m->add($data);
            if(!$res) die('æ·»åŠ å¤±è´¥');

            $msg = 'success';

            // ä¸Šä¼ å•†å“å›¾ç‰‡
            if($_FILES['news_cover']['name'])
            {
                $up_res = $this->uploadsImg($res);
                if($up_res['err_no']==1)
                {
                    foreach($up_res['info'] as $fk=>$file)
                    {
                        if($fk=='news_cover') $change_data['news_cover']  = $file['savepath'].$file['savename'];
                    }
                    $this->_m->where('id='.$res)->save($change_data);
                }
                else
                {
                    $msg .= $up_res['err_msg'];
                }
            }
            die($msg);
        }
        $this->assign('come_from',C('NEWS_COME_FROM'));
        $this->display();
    }

    /*ä¸Šä¼ å›¾ç‰‡*/
    private function uploadsImg($savePath)
    {

        $data = array();
        if(!$_FILES)
        {
            $data['err_no']     = 2;
            $data['err_msg']    = 'æ²¡æœ‰æ–‡ä»¶ä¸Šä¼ ';
        }
        else
        {
            $rootPath = $this->_pic_path;
            directory($rootPath);
            //if(!is_dir($rootPath)) mkdir($rootPath);
            $upload = new \Think\Upload();// å®ä¾‹åŒ–ä¸Šä¼ ç±»
            $upload->maxSize   =     10240000;// è®¾ç½®é™„ä»¶ä¸Šä¼ å¤§å°
            $upload->exts      =     array('jpg', 'gif', 'png', 'jpeg');// è®¾ç½®é™„ä»¶ä¸Šä¼ ç±»å‹
            $upload->rootPath  =     $rootPath; // è®¾ç½®é™„ä»¶ä¸Šä¼ æ ¹ç›®å½•
            $upload->autoSub   =     false;
            //$upload->savePath  =      '/'.$savePath.'/'; // è®¾ç½®é™„ä»¶ä¸Šä¼ ï¼ˆå­ï¼‰ç›®å½•
            $upload->savePath  =      '/'; // è®¾ç½®é™„ä»¶ä¸Šä¼ ï¼ˆå­ï¼‰ç›®å½•
            $upload->saveName  =      array('uniqid',$savePath.'_');

            // ä¸Šä¼ æ–‡ä»¶
            $info   =   $upload->upload();
            if(!$info)
            {// ä¸Šä¼ é”™è¯¯æç¤ºé”™è¯¯ä¿¡æ¯
                $data['err_no']     = 3;
                $data['err_msg']    = $upload->getError();
            }
            else
            {// ä¸Šä¼ æˆåŠŸ è·å–ä¸Šä¼ æ–‡ä»¶ä¿¡æ¯
                $data['err_no']     = 1;
                $data['err_msg']    = 'success';
                $data['info']       = $info;
            }
        }
        return $data;
    }

    public function edit()
    {
        $id   = I('get.id');
        $data = I('post.');

        if($data) {

            foreach ($this->_not_null as $k=>$v)
            {
                if(!$data[$k]) die($v);
            }

            if($data['top_num'])
            {
                $this->_m->where('top_num=1 and id !='.$data['id'])->setField('top_num',0);
                $data['top_num'] = 1;
            }
            else
            {
                $data['top_num'] = 0;
            }

            $data['newstime'] = strtotime($data['newstime']);
            $data['newstime_date'] = date('Y-m-d',$data['newstime']);
            $res = $this->_m->where('id='.$data['id'])->save($data);
            $msg = 'success';

            // ä¸Šä¼ å•†å“å›¾ç‰‡
            if($_FILES['news_cover']['name'])
            {
                $up_res = $this->uploadsImg($res);
                if($up_res['err_no']==1)
                {
                    foreach($up_res['info'] as $fk=>$file)
                    {
                        if($fk=='news_cover') $change_data['news_cover']  = $file['savepath'].$file['savename'];
                    }
                    $change_img_res = $this->_m->where('id='.$data['id'])->save($change_data);
                }
                else
                {
                    $msg .= $up_res['err_msg'];
                }
            }
            if(!$res and !$change_img_res) die('ä¿®æ”¹å¤±è´¥');
            die($msg);
        }

        $info = $this->_m->where('id='.$id)->find();
        if(!$info) die('è¯¥è®°å½•ä¸å­˜åœ¨!');
        $info = $this->disposeData($info);
        $this->assign('come_from',C('NEWS_COME_FROM'));
        $this->assign('info',$info);
        $this->display();
    }

    public function disposeData($arr)
    {
        /*åˆ›å»ºæ—¶é—´*/
        $arr['create_date'] = date('Y-m-d',$arr['create_time']);

        /*å‘å¸ƒæ—¶é—´*/
        $arr['newstime_date'] = date('Y-m-d H:i:s',$arr['newstime']);

        /*å›¾ç‰‡*/
        if($arr['news_cover']) $arr['news_cover'] = getSelf().$this->_pic_path.$arr['news_cover'];

        /*æ¥æº*/
        if($arr['come_from']) $arr['come_from_info'] = C('NEWS_COME_FROM')[$arr['come_from']];

        /*ç½®é¡¶*/
        if($arr['top_num']==1) $arr['top_num_info'] = 'ç½®é¡¶ğŸ”';
        return $arr;
    }
}